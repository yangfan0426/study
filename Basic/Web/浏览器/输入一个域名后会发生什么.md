# 输入域名后发生的完整过程

## 1. 浏览器预处理
- **输入检查**：浏览器检查输入是否为搜索关键词或URL
- **协议补全**：自动添加缺失的协议（如`http://`或`https://`）
- **HSTS预加载**：检查域名是否在HSTS预加载列表中，强制使用HTTPS

## 2. DNS解析（详细过程）
- **本地缓存查询**：
  - 浏览器DNS缓存 → 操作系统缓存 → 路由器缓存
  - 检查hosts文件是否有手动映射
- **递归查询**：
  - 向本地配置的DNS服务器（ISP提供或自定义如8.8.8.8）发起查询
- **迭代解析**：
  - 本地DNS服务器依次查询：
    - 根域名服务器（获得顶级域服务器地址）
    - 顶级域服务器（如.com，获得权威域名服务器地址）
    - 权威域名服务器（获得最终IP地址）
- **结果返回与缓存**：
  - 将IP地址返回浏览器并缓存（遵循TTL设置）
  - 可能涉及DNS负载均衡（返回多个IP）

## 3. 建立网络连接
- **TCP三次握手**：
  - SYN → SYN-ACK → ACK
  - 协商序列号、窗口大小等参数
- **TLS握手（HTTPS）**：
  - Client Hello：支持的TLS版本、密码套件、随机数
  - Server Hello：选择的TLS版本、密码套件、随机数、服务器证书
  - 证书验证：检查证书链、有效期、域名匹配、CRL/OCSP撤销状态
  - 密钥交换：预主密钥生成与交换（RSA或ECDHE）
  - 会话密钥生成：基于随机数和预主密钥计算加密密钥
  - 加密通信开始：使用协商的对称密钥加密数据传输

## 4. 发送HTTP请求
- **请求构建**：
  - 方法（GET/POST等）、路径、HTTP版本
  - 请求头：Host、User-Agent、Accept、Cookie、Referer等
  - 请求体（如POST表单数据）
- **协议特性**：
  - HTTP/1.1：持久连接、管道化
  - HTTP/2：多路复用、头部压缩、服务器推送
  - HTTP/3：基于QUIC（UDP）、0-RTT连接建立

## 5. 服务器处理
- **基础设施**：
  - 负载均衡器分配请求到后端服务器
  - Web服务器（Nginx/Apache）处理静态资源或反向代理
  - 应用服务器（Tomcat/Node.js）执行业务逻辑
  - 数据库/缓存查询（MySQL/Redis）
- **处理流程**：
  - 解析请求头和数据
  - 会话管理（Session/Cookie）
  - 身份验证与授权
  - 业务逻辑处理与数据操作
  - 生成响应（HTML/JSON/XML等）

## 6. 接收响应
- **状态处理**：
  - 1xx：信息响应（如101 Switching Protocols）
  - 2xx：成功（200 OK、206 Partial Content）
  - 3xx：重定向（301 Moved Permanently、302 Found）
  - 4xx：客户端错误（404 Not Found、403 Forbidden）
  - 5xx：服务器错误（500 Internal Server Error）
- **内容处理**：
  - 解析响应头（Content-Type、Cache-Control、Set-Cookie等）
  - 根据Content-Type处理不同类型内容：
    - text/html：HTML文档
    - application/json：JSON数据
    - image/*：图片资源
    - application/octet-stream：文件下载
  - 缓存策略处理（强缓存、协商缓存）

## 7. 浏览器渲染引擎工作流程
- **解析**：
  - HTML解析：构建DOM树（字节→字符→令牌→节点→对象模型）
  - CSS解析：构建CSSOM树（字节→字符→令牌→节点→CSSOM）
  - 预加载扫描器：提前请求关键资源（CSS/JS/字体）
- **渲染树构建**：
  - 合并DOM和CSSOM形成渲染树（仅包含可见元素）
- **布局**：
  - 计算每个节点的几何信息（位置、尺寸）
  - 回流：重新计算布局（当布局变化时）
- **绘制**：
  - 将渲染树转换为屏幕上的像素
  - 重绘：更新元素外观而不影响布局
- **合成**：
  - 将分层内容合并为最终页面
  - GPU加速处理变换和透明度

## 8. JavaScript执行
- **解析与编译**：JavaScript引擎（V8/SpiderMonkey）解析、编译和执行代码
- **事件循环**：处理任务队列、微任务队列、渲染帧
- **DOM操作**：通过JavaScript API与DOM交互
- **Web API**：调用setTimeout、Fetch、DOM事件等

## 9. 资源加载与处理
- **静态资源**：
  - 图片、视频、字体等媒体内容解码与渲染
  - 样式表应用与计算
- **异步内容**：
  - AJAX/Fetch请求获取动态数据
  - WebSocket建立持久连接
  - Service Worker处理离线缓存

## 10. 连接管理
- **持久连接**：HTTP/1.1+默认保持连接开放
- **连接终止**：四次挥手关闭TCP连接（FIN → ACK → FIN → ACK）
- **资源释放**：清理内存占用、断开网络连接

## 11. 后续交互
- **事件处理**：用户交互（点击、滚动、输入）触发事件处理
- **状态管理**：History API管理会话历史
- **性能优化**：懒加载、预加载、预渲染等策略

## 附加过程
- **CDN加速**：静态资源从边缘节点获取
- **安全检测**：浏览器安全策略（CORS、CSP、XSS保护）
- **隐私保护**：跟踪防护、Cookie限制
- **扩展干预**：浏览器扩展可能修改请求和响应
